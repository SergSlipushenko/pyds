#! /usr/bin/env /usr/bin/python

import httplib
import json
import sys
import socket
import subprocess
import time

if len(sys.argv) == 1:
    print "no tag specified"
    exit(1)

tag = sys.argv[1]
server = sys.argv[2] if sys.argv[2:3] else '127.0.0.1:7070'

co = subprocess.Popen(['/sbin/ifconfig'], stdout=subprocess.PIPE)
iface_blocks = [block for block in co.stdout.read().split('\n\n') if block]
ips = {}
for block in iface_blocks:
    name = block.split()[0]
    ip = next((line.strip().split(':')[1].split(' ')[0]
               for line in block.split('\n') if 'inet addr:' in line), None)
    if ip:
        ips[name] = ip

data = json.dumps({tag: ips})
h = httplib.HTTPConnection(server)
headers = {'Content-type': 'application/json'}
h.request('POST', '/', data, headers)
r = h.getresponse()
if r.status == 200:
    print 'Reported to %s' % server
    print ips
